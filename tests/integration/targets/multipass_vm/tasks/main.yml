---
- name: Ensure multipass VM named {{vm.name}} doesn't exist
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: absent
    purge: true

- name: Create a multipass VM
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: present
    cpus: "{{vm.custom.cpus}}"
    memory: "{{vm.custom.memory}}"
    disk: "{{vm.custom.disk}}"
    # TODO: implement test network interface in CI to test
    #networks: 
    #- name: "{{vm.custom.networks.net1}}"
  register: create_vm

- name: Get the created VM specs
  theko2fi.multipass.multipass_config_get:
    key: "local.{{vm.name}}.{{item}}"
  register: create_vm_config
  with_items:
    - memory
    - disk

- name: Verify that VM has been created
  ansible.builtin.assert:
    that:
      - create_vm.changed
      - create_vm.result.info.{{vm.name}}.state == "Running"
      - create_vm.result.info.{{vm.name}}.cpu_count == "{{vm.custom.cpus}}"
      - create_vm_config.results[0].result == "{{vm.custom.memory}}"
      - create_vm_config.results[1].result == "{{vm.custom.disk}}"

- name: Stop multipass VM
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: stopped
  register: stop_vm

- name: Verify that VM has been stopped
  ansible.builtin.assert:
    that:
      - stop_vm.changed

- name: Start a multipass VM which was stopped
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: started
  register: start_vm

- name: Verify that VM has been started
  ansible.builtin.assert:
    that:
      - start_vm.changed
      - start_vm.result.info.{{vm.name}}.state == "Running"

- name: Recreate the multipass VM
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: present
    recreate: true
  register: recreate_vm
  
- name: Get the recreated VM specs
  theko2fi.multipass.multipass_config_get:
    key: "local.{{vm.name}}.{{item}}"
  register: recreate_vm_config
  with_items:
    - memory
    - disk

- name: Verify that VM has been recreated with default values
  ansible.builtin.assert:
    that:
      - recreate_vm.changed
      - recreate_vm.result.info.{{vm.name}}.state == "Running"
      - recreate_vm.result.info.{{vm.name}}.cpu_count == "{{vm.default.cpus}}"
      - recreate_vm_config.results[0].result == "{{vm.default.memory}}"
      - recreate_vm_config.results[1].result == "{{vm.default.disk}}"

- name: Delete the multipass VM
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: absent
  register: delete_vm

- name: Verify that VM has been deleted
  ansible.builtin.assert:
    that:
      - delete_vm.changed

- name: Try to stop a deleted multipass VM to check idempotency
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: stopped
  register: stop_vm

- name: Verify that VM stop is idempotent
  ansible.builtin.assert:
    that:
      - stop_vm.changed == False

- name: Start a deleted VM
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: started
  register: started_vm

- name: Verify that VM has been started
  ansible.builtin.assert:
    that:
      - started_vm.changed
      - started_vm.result.info.{{vm.name}}.state == "Running"

- name: Delete and purge a VM
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: absent
    purge: true
  register: purge_vm

- name: Verify that VM has been purged
  ansible.builtin.assert:
    that:
      - purge_vm.changed

- name: Delete and purge a VM (check idempotency)
  theko2fi.multipass.multipass_vm:
    name: "{{vm.name}}"
    state: absent
    purge: true
  register: repurge_vm

- name: Verify that VM purge is idempotent 
  ansible.builtin.assert:
    that:
      - repurge_vm.changed == False

- name: Include mount tests
  ansible.builtin.import_tasks: mount.yml