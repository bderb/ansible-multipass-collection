---
- name: Get current user's UID
  command: id -u
  register: uid_output
  changed_when: false
  check_mode: no

- name: Set facts
  set_fact:
    mount_source_for_test: "{{ansible_env.HOME}}/foo_bar"
    current_user_uid: "{{ uid_output.stdout | int }}"
    vm_name: "zobosky"

- name: Create VM if it doesn't exist
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: absent
    purge: true

- name: Ensure the VM exists for the test
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: present

- name: Create '{{ mount_source_for_test }}' directory if it does not exist
  ansible.builtin.file:
    path: "{{ mount_source_for_test }}"
    state: directory

- name: Mount directories to multipass VM
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: present
    mounts:
      - source: "{{ mount_source_for_test }}"
        target: "/tmpyy"
        gid_map: ["50:50","500:25"]
        uid_map: ["1000:1000"]
      - source: "/tmp"
        target: "/tmpxx"
  register: create_vm_with_mounts

- name: Verify that VM has been created with mounts
  ansible.builtin.assert:
    that:
      - create_vm_with_mounts.changed
      - "'/tmpxx' in create_vm_with_mounts.result.info.zobosky.mounts"
      - "'/tmpyy' in create_vm_with_mounts.result.info.zobosky.mounts"
      - create_vm_with_mounts.result.info.zobosky.mounts['/tmpyy'].gid_mappings == ["50:50","500:25"]
      - create_vm_with_mounts.result.info.zobosky.mounts['/tmpyy'].uid_mappings == ["1000:1000"]

- name: Reduce gid_map
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: present
    mounts:
      - source: "{{ mount_source_for_test }}"
        target: "/tmpyy"
        gid_map: ["50:50"]
        uid_map: ["1000:1000"]
      - source: "/tmp"
        target: "/tmpxx"
  register: reduce_gid_map

- name: Verify that gid_map reduced
  ansible.builtin.assert:
    that:
      - reduce_gid_map.changed
      - reduce_gid_map.result.info.zobosky.mounts['/tmpyy'].gid_mappings == ["50:50"]

- name: Remove uid_map
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: present
    mounts:
      - source: "{{ mount_source_for_test }}"
        target: "/tmpyy"
        gid_map: ["50:50"]
      - source: "/tmp"
        target: "/tmpxx"
  register: remove_uid_map

- name: Verify that uid_map reverted to default
  ansible.builtin.assert:
    that:
      - remove_uid_map.changed
      - remove_uid_map.result.info.zobosky.mounts['/tmpyy'].uid_mappings == ["%s:default" % (current_user_uid)]

- name: change '/tmpxx' mount point to '/tmpzz'
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: present
    mounts:
      - source: "{{ mount_source_for_test }}"
        target: "/tmpyy"
        gid_map: ["50:50"]
      - source: "/tmp"
        target: "/tmpzz"
  register: change_mount_point

- name: Verify that '/tmpxx' changed to '/tmpzz'
  ansible.builtin.assert:
    that:
      - change_mount_point.changed
      - "'/tmpxx' not in change_mount_point.result.info.zobosky.mounts"
      - change_mount_point.result.info.zobosky.mounts['/tmpzz'].source_path == "/tmp"

- name: Remove one mount point
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: present
    mounts:
      - source: "/tmp"
        target: "/tmpzz"
  register: remove_one_mount_point

- name: Verify that '/tmpyy' mount point has been removed
  ansible.builtin.assert:
    that:
      - remove_one_mount_point.changed
      - "'/tmpyy' not in remove_one_mount_point.result.info.zobosky.mounts"

- name: Remove one mount point (check idempotency)
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: present
    mounts:
      - source: "/tmp"
        target: "/tmpzz"
  register: remove_one_mount_point_idempotency

- name: Verify that '/tmpyy' mount point has been removed (idempotency)
  ansible.builtin.assert:
    that:
      - remove_one_mount_point_idempotency.changed == False

- name: Delete and purge VM
  theko2fi.multipass.multipass_vm:
    name: "zobosky"
    state: absent
    purge: true